@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using System.Drawing
@using System.ComponentModel
@using System.Globalization
@using global::ColorPicker.Core.Models
@using global::ColorPicker.View.Blazor.Interfaces
@using global::ColorPicker.View.Blazor.Models
@using Microsoft.AspNetCore.Components.Forms

@if (Layout is null)
{
    <style>
        .color-picker-layout {
            display: grid;
            grid-template-columns: auto 400px;
            grid-template-rows: minmax(0, 1fr) auto;
            height: 100vh;
            max-height: 600px;
        }

        .colorSelection-area {
            grid-column: 1;
            grid-row: 1;
        }

        .controls {
            grid-column: 2;
            grid-row: 1;
            margin-left: 8px;
        }

        .group {
            padding: 6px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .row {
            display: grid;
            grid-template-columns: 30px 70px 120px;
            gap: 6px;
            align-items: center;
        }

        .hex-row {
            display: grid;
            grid-template-columns: 35px 100px;
            gap: 6px;
            margin-bottom: 8px;
        }

        .bottom-bar {
            margin-top: 6px;
            grid-column: 1;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-height: 100px;
        }

    </style>
}

<CascadingValue Name="ShareDataModel" Value="_shareDataModel">
    <CascadingValue Name="MainViewModel" Value="_viewModel">
        @if (Layout != null)
        {
            @Layout(CreateLayoutContext())
        }
        else
        {
            @DefaultLayout
        }
    </CascadingValue>
</CascadingValue>

@code {
    @inject IJSRuntime JSRuntime

    private readonly ColorPickerViewModel _viewModel = new ColorPickerViewModel();
    private readonly ShareDataModel _shareDataModel = new ShareDataModel();

    private Color _lastSelectedColor;

    [Parameter]
    public RenderFragment<LayoutContext>? Layout { get; set; }

    [Parameter]
    public Color SelectedColor { get; set; }

    [Parameter]
    public EventCallback<Color> SelectedColorChanged { get; set; }

    /// <summary>
    /// Created layout.
    /// </summary>
    /// <returns></returns>
    private LayoutContext CreateLayoutContext() => new()
    {
        PART_ColorSelectionView = @<ColorPicker.View.Blazor.Components.ColorSelectionView />,
        PART_HueSelectionView = @<ColorPicker.View.Blazor.Components.HueSelectionView />,
        PART_AlphaSelectionView = @<ColorPicker.View.Blazor.Components.AlphaSelectionView />,
        PART_SelectedColorView = @<ColorPicker.View.Blazor.Components.SelectedColorView />,        
        
        // HEX
        PART_HexTextBox = @<input data-part="hex-text-box" @bind=@_viewModel.Hex.Hex @oninput="((args) => _viewModel.Hex.Hex = args.Value?.ToString())" />,
        
        // RGB
        PART_RedTextBox = @TextBox(_red, "red-text-box"),
        PART_RedSlider = @Slider(() => _red.Value, v => _red.Value = v, 0, 255, "red-slider"),
        PART_GreenTextBox = @TextBox(_green, "green-text-box"),
        PART_GreenSlider = @Slider(() => _green.Value, v => _green.Value = v, 0, 255, "green-slider"),
        PART_BlueTextBox = @TextBox(_blue, "blue-text-box"),
        PART_BlueSlider = @Slider(() => _blue.Value, v => _blue.Value = v, 0, 255, "blue-slider"),
        
        // Alpha
        PART_AlphaTextBox = @TextBox(_alpha, "alpha-text-box"),
        PART_AlphaSlider = @Slider(() => _alpha.Value, v => _alpha.Value = v, 0, 100, "alpha-slider"),

        // HSV
        PART_HueTextBox = @TextBox(_hue, "hue-text-box"),
        PART_HueSlider = @Slider(() => _hue.Value, v => _hue.Value = v, 0, 360, "hue-slider"),
        PART_SaturationTextBox = @TextBox(_saturation, "saturation-text-box"),
        PART_SaturationSlider = @Slider(() => _saturation.Value, v => _saturation.Value = v, 0, 100, "saturation-slider"),
        PART_ValueTextBox = @TextBox(_value, "value-text-box"),
        PART_ValueSlider = @Slider(() => _value.Value, v => _value.Value = v, 0, 100, "value-slider"),
    
        // HSL
        PART_HslHueTextBox = @TextBox(_hslHue, "hsl-hue-text-box"),
        PART_HslHueSlider = @Slider(() => _hslHue.Value, v => _hslHue.Value = v, 0, 360, "hsl-hue-slider"),
        PART_HslSaturationTextBox = @TextBox(_hslSaturation, "hsl-saturation-text-box"),
        PART_HslSaturationSlider = @Slider(() => _hslSaturation.Value, v => _hslSaturation.Value = v, 0, 100, "hsl-saturation-slider"),
        PART_HslLightnessTextBox = @TextBox(_hslLightness, "hsl-lightness-text-box"),
        PART_HslLightnessSlider = @Slider(() => _hslLightness.Value, v => _hslLightness.Value = v, 0, 100, "hsl-lightness-slider"),

        // CMYK
        PART_CyanTextBox = @TextBox(_cyan, "cyan-text-box"),
        PART_CyanSlider = @Slider(() => _cyan.Value, v => _cyan.Value = v, 0, 100, "cyan-slider"),
        PART_MagentaTextBox = @TextBox(_magenta, "magenta-text-box"),
        PART_MagentaSlider = @Slider(() => _magenta.Value, v => _magenta.Value = v, 0, 100, "magenta-slider"),
        PART_YellowTextBox = @TextBox(_yellow, "yellow-text-box"),
        PART_YellowSlider = @Slider(() => _yellow.Value, v => _yellow.Value = v, 0, 100, "yellow-slider"),
        PART_KeyTextBox = @TextBox(_key, "key-text-box"),
        PART_KeySlider = @Slider(() => _key.Value, v => _key.Value = v, 0, 100, "key-slider")
    };

    private RenderFragment DefaultLayout => 
    @<div class="color-picker-layout">
        <div class="colorSelection-area">
            <ColorPicker.View.Blazor.Components.ColorSelectionView />
        </div>
    
        <div class="controls">
            <!--HEX-->
            <div class="hex-row">
                <label>HEX</label>
                <input data-part="hex-text-box" @bind=@_viewModel.Hex.Hex @oninput="((args) => _viewModel.Hex.Hex = args.Value?.ToString())" />
            </div>

            <!--RGB-->
            <div class="group">
                <!--Red-->
                <div class="row">
                    <label>R</label>
                    @TextBox(_red, "red-text-box")
                    @Slider(() => _red.Value, v => _red.Value = v, 0, 255, "red-slider")
                </div>
                <!--Green-->
                <div class="row">
                    <label>G</label>
                    @TextBox(_green, "green-text-box")
                    @Slider(() => _green.Value, v => _green.Value = v, 0, 255, "green-slider")
                </div>
                <!--Blue-->
                <div class="row">
                    <label>B</label>
                    @TextBox(_blue, "blue-text-box")
                    @Slider(() => _blue.Value, v => _blue.Value = v, 0, 255, "blue-slider")
                </div>
            </div>

            <!--Alpha-->
            <div class="group">
                <div class="row">
                    <label>A</label>
                    @TextBox(_alpha, "alpha-text-box")
                    @Slider(() => _alpha.Value, v => _alpha.Value = v, 0, 100, "alpha-slider")
                </div>
            </div>

            <!--HSV-->
            <div class="group">
                <div class="row">
                    <label>H</label>
                    @TextBox(_hue, "hue-text-box")
                    @Slider(() => _hue.Value, v => _hue.Value = v, 0, 360, "hue-slider")
                </div>
                <div class="row">
                    <label>S</label>
                    @TextBox(_saturation, "saturation-text-box")
                    @Slider(() => _saturation.Value, v => _saturation.Value = v, 0, 100, "saturation-slider")
                </div>
                <div class="row">
                    <label>V</label>
                    @TextBox(_value, "value-text-box")
                    @Slider(() => _value.Value, v => _value.Value = v, 0, 100, "value-slider")
                </div>
            </div>

            <!--HSL-->
            <div class="group">
                <div class="row">
                    <label>H</label>
                    @TextBox(_hslHue, "hsl-hue-text-box")
                    @Slider(() => _hslHue.Value, v => _hslHue.Value = v, 0, 360, "hsl-hue-slider")
                </div>
                <div class="row">
                    <label>S</label>
                    @TextBox(_hslSaturation, "hsl-saturation-text-box")
                    @Slider(() => _hslSaturation.Value, v => _hslSaturation.Value = v, 0, 100, "hsl-saturation-slider")
                </div>
                <div class="row">
                    <label>L</label>
                    @TextBox(_hslLightness, "hsl-lightness-text-box")
                    @Slider(() => _hslLightness.Value, v => _hslLightness.Value = v, 0, 100, "hsl-lightness-slider")
                </div>
            </div>

            <!--CMYK-->
            <div class="group">
                <div class="row">
                    <label>C</label>
                    @TextBox(_cyan, "cyan-text-box")
                    @Slider(() => _cyan.Value, v => _cyan.Value = v, 0, 100,  "cyan-slider")
                </div>
                <div class="row">
                    <label>M</label>
                    @TextBox(_magenta, "magenta-text-box")
                    @Slider(() => _magenta.Value, v => _magenta.Value = v, 0, 100, "magenta-slider")
                </div>
                <div class="row">
                    <label>Y</label>
                    @TextBox(_yellow, "yellow-text-box")
                    @Slider(() => _yellow.Value, v => _yellow.Value = v, 0, 100, "yellow-slider")
                </div>
                <div class="row">
                    <label>K</label>
                    @TextBox(_key, "key-text-box")
                    @Slider(() => _key.Value, v => _key.Value = v, 0, 100, "key-slider")
                </div>
            </div>
        </div>

        <div class="bottom-bar">
            <ColorPicker.View.Blazor.Components.HueSelectionView />            
            <ColorPicker.View.Blazor.Components.AlphaSelectionView />            
            <ColorPicker.View.Blazor.Components.SelectedColorView />
        </div>
    </div>
    ;

    // RGB
    private ByteBinding<RgbModel> _red = default!;
    private ByteBinding<RgbModel> _green = default!;
    private ByteBinding<RgbModel> _blue = default!;

    // Alpha
    private PercentBinding<AlphaModel> _alpha = default!;

    // HSV
    private DegreeBinding<HsvModel> _hue = default!;
    private PercentBinding<HsvModel> _saturation = default!;
    private PercentBinding<HsvModel> _value = default!;

    // HSL
    private DegreeBinding<HslModel> _hslHue = default!;
    private PercentBinding<HslModel> _hslSaturation = default!;
    private PercentBinding<HslModel> _hslLightness = default!;

    // CMYK
    private PercentBinding<CmykModel> _cyan = default!;
    private PercentBinding<CmykModel> _magenta = default!;
    private PercentBinding<CmykModel> _yellow = default!;
    private PercentBinding<CmykModel> _key = default!;

    /// <summary>
    /// Initializes a new instance of the ColorPicker class.
    /// </summary>
    public ColorPicker()
    {
        _viewModel.Hex.PropertyChanged += Hex_PropertyChanged;
    }

    /// <summary>
    /// Method invoked when the component has received parameters from its parent in the render tree, and the incoming values have been assigned to properties.
    /// </summary>
    protected override void OnParametersSet()
    {
        if (!_lastSelectedColor.Equals(SelectedColor))
        {
            _lastSelectedColor = SelectedColor;
            _viewModel.SelectColor(SelectedColor.R, SelectedColor.G, SelectedColor.B, SelectedColor.A / 255f);
        }
    }

    /// <summary>
    /// Update the selected color from change in UI.
    /// </summary>
    /// <param name="sender"></param>
    /// <param name="e"></param>
    private void Hex_PropertyChanged(object? sender, PropertyChangedEventArgs e)
    {
        InvokeAsync(async () =>
        {
            Color newColor = ColorTranslator.FromHtml(_viewModel.Hex.Hex);

            SelectedColor = newColor;
            await SelectedColorChanged.InvokeAsync(newColor);
        });
    }

    /// <summary>
    /// Method invoked after each time the component has been rendered interactively and the UI has finished updating.
    /// </summary>
    /// <returns></returns>
    protected override void OnInitialized()
    {
        SetRgb();
        SetAlpha();
        SetHsv();
        SetHsl();
        SetCmyk();
    }

    /// <summary>
    /// Sets the RGB components.
    /// </summary>
    private void SetRgb()
    {
        _red = new ByteBinding<RgbModel>(
            new BytePropertyBinding<RgbModel>(_viewModel.Rgb, x => x.Red)
        );
        _green = new ByteBinding<RgbModel>(
            new BytePropertyBinding<RgbModel>(_viewModel.Rgb, x => x.Green)
        );
        _blue = new ByteBinding<RgbModel>(
            new BytePropertyBinding<RgbModel>(_viewModel.Rgb, x => x.Blue)
        );
    }

    /// <summary>
    /// Sets the Alpha component.
    /// </summary>
    private void SetAlpha()
    {
        _alpha = new PercentBinding<AlphaModel>(
            new FloatPropertyBinding<AlphaModel>(_viewModel.Alpha, x => x.Alpha)
        );
    }

    /// <summary>
    /// Sets the HSV components.
    /// </summary>
    private void SetHsv()
    {
        _hue = new DegreeBinding<HsvModel>(
            new FloatPropertyBinding<HsvModel>(_viewModel.Hsv, x => x.Hue)
        );
        _saturation = new PercentBinding<HsvModel>(
            new FloatPropertyBinding<HsvModel>(_viewModel.Hsv, x => x.Saturation)
        );
        _value = new PercentBinding<HsvModel>(
            new FloatPropertyBinding<HsvModel>(_viewModel.Hsv, x => x.Value)
        );
    }

    /// <summary>
    /// Sets the HSL components.
    /// </summary>
    private void SetHsl()
    {
        _hslHue = new DegreeBinding<HslModel>(
            new FloatPropertyBinding<HslModel>(_viewModel.Hsl, x => x.Hue)
        );
        _hslSaturation = new PercentBinding<HslModel>(
            new FloatPropertyBinding<HslModel>(_viewModel.Hsl, x => x.Saturation)
        );
        _hslLightness = new PercentBinding<HslModel>(
            new FloatPropertyBinding<HslModel>(_viewModel.Hsl, x => x.Lightness)
        );
    }

    /// <summary>
    /// Sets the CMYK components.
    /// </summary>
    private void SetCmyk()
    {
        _cyan = new PercentBinding<CmykModel>(
            new FloatPropertyBinding<CmykModel>(_viewModel.Cmyk, x => x.Cyan)
        );
        _magenta = new PercentBinding<CmykModel>(
            new FloatPropertyBinding<CmykModel>(_viewModel.Cmyk, x => x.Magenta)
        );
        _yellow = new PercentBinding<CmykModel>(
            new FloatPropertyBinding<CmykModel>(_viewModel.Cmyk, x => x.Yellow)
        );
        _key = new PercentBinding<CmykModel>(
            new FloatPropertyBinding<CmykModel>(_viewModel.Cmyk, x => x.Key)
        );
    }

    /// <summary>
    /// Creates the text box input.
    /// </summary>
    /// <param name="model">Data model.</param>
    /// <param name="dataPart">Data part name.</param>
    /// <returns>The text box input.</returns>
    private RenderFragment TextBox(IValueBinding model, string dataPart) => builder =>
    {
        builder.OpenElement(0, "input");
        builder.AddAttribute(1, "type", "text");
        builder.AddAttribute(2, "data-part", dataPart);
        builder.AddAttribute(3, "value", model.Text);

        builder.AddAttribute(4, "onfocus",
            EventCallback.Factory.Create(this, model.OnFocus));

        builder.AddAttribute(5, "oninput",
            EventCallback.Factory.Create<ChangeEventArgs>(
                this, e => model.OnInput(e.Value?.ToString())));

        builder.AddAttribute(6, "onblur",
            EventCallback.Factory.Create(this, model.OnBlur));

        builder.CloseElement();
    };

    /// <summary>
    /// Creates the range input.
    /// </summary>
    /// <param name="getValue">Getter for the value.</param>
    /// <param name="setValue">Setter for the value.</param>
    /// <param name="min">Min value.</param>
    /// <param name="max">Max value.</param>
    /// <param name="dataPart">Data part name.</param>
    /// <returns>The range input.</returns>
    private RenderFragment Slider(Func<int> getValue, Action<int> setValue, int min, int max, string dataPart)
    {
        return builder =>
        {
            builder.OpenElement(0, "input");
            builder.AddAttribute(1, "type", "range");
            builder.AddAttribute(2, "data-part", dataPart);
            builder.AddAttribute(3, "min", min);
            builder.AddAttribute(4, "max", max);
            builder.AddAttribute(5, "step", 1);
            builder.AddAttribute(6, "value", getValue());

            builder.AddAttribute(7, "oninput",
                EventCallback.Factory.Create<ChangeEventArgs>(
                    this, e => setValue(int.Parse(e.Value!.ToString()!))));

            builder.CloseElement();
        };
    }

    /// <summary>
    /// Releases all resources used by this instance.
    /// </summary>
    public void Dispose()
    {
        _red?.Dispose();
        _green?.Dispose();
        _blue?.Dispose();

        _alpha?.Dispose();

        _hue?.Dispose();
        _saturation?.Dispose();
        _value?.Dispose();

        _hslHue?.Dispose();
        _hslSaturation?.Dispose();
        _hslLightness?.Dispose();

        _cyan?.Dispose();
        _magenta?.Dispose();
        _yellow?.Dispose();
        _key?.Dispose();
    }
}